/*!
 * backbone.layoutmanager.js v0.4.0
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(a){function e(a){c.each([].concat(a),function(a){a.unbind(),a.views&&c.each(a.views,function(a){e(a)}),c.isFunction(a.cleanup)&&a.cleanup.call(a)})}function f(a){function h(c,d){g.cache(b,d),d&&f.html(a.el,f.render(d,c)),e.resolveWith(a,[a.el])}var b,d,e,f=a._options();return{insert:function(b,c){return c?a.view(b,c,!0):a.view(b,!0)},raw:a,render:function(i){var j=a.template||f.template;return a.serialize&&(f.serialize=a.serialize),!i&&c.isFunction(f.serialize)?i=f.serialize.call(a):!i&&c.isObject(f.serialize)&&(i=f.serialize),e=g._makeAsync(f,c.bind(h,a,i)),c.isString(j)&&(b=a._prefix+j),(d=g.cache(b))?(h(i,d,b),e):(c.isString(j)?d=f.fetch.call(e,a._prefix+j):j!=null&&(d=f.fetch.call(e,j)),e._isAsync||h(i,d),e)}}}"use strict";var b=a.Backbone,c=a._,d=a.$,g=b.View.extend({__manager__:{},constructor:function(a){var d=b.LayoutManager.prototype;a=c.extend({},d.options,a),this._render=function(a){return a(this).render()},this.views={},this.render!==d.render&&(this._render=this.render,this.render=d.render),this._remove=b.View.prototype.remove,this.remove!==d.remove&&(this._remove=this.remove,this.remove=d.remove),a.paths&&(this._prefix=a.paths.layout||""),a.views&&this.setViews(a.views),this.template&&(a.template=this.template),b.View.call(this,a)},setViews:function(a){return c.each(a,function(a,b){c.isArray(a)?c.each(a,function(a){this.view(b,a,!0)},this):this.view(b,a)},this),this},view:function(d,e,f){var h,i,j=this;return c.isString(d)||(f=e,e=d,d=""),this.views||(this.views={}),e.__manager__||(e.__manager__={},e instanceof g||(e._render=e.render,e.render===b.View.prototype.render&&(e._render=function(a){return a(this).render()}),e.views&&(e.options.views=e.views),c.extend(e,{views:{},view:g.prototype.view,setViews:g.prototype.setViews,_options:g.prototype._options})),f||(e.__manager__.isManaged=!0),e._remove=e.remove,e.remove=g.prototype.remove,e.render=function(b){function k(a){f||(i.detach(e.el),i.partial(j.el,d,e.el)),e.delegateEvents(),c.isFunction(b)&&b.call(e,e.el)}function l(){e.__manager__.hasRendered||(i.detach(e.el),i.partial(j.el,d,e.el,f),e.delegateEvents(),e.__manager__.hasRendered=!0),h.resolveWith(e,[e.el]).then(k)}var h=i.deferred();try{g.prototype.render.call(e,l)}catch(m){a.setTimeout(function(){g.prototype.render.call(e,l)},0)}return h.promise()},i=e._options(),!e._prefix&&i.paths&&(e._prefix=i.paths.template||""),i.views&&e.setViews(i.views)),f?(h=this.views[d]=this.views[d]||[],h.push(e),e):this.views[d]=e},render:function(a){var b=this,d=this._options(),g=d.deferred();return this._render(f).then(function(){var a=c.chain(b.views).map(function(a){return a}).flatten().value();e(a,this),c.each(a,function(a){a.remove()},this);var f=c.map(b.views,function(a){function e(a,b){if(!a.length)return b();var c=a.shift();c.__manager__.isManaged=!0,c.render(function(){e(a,b)})}var b;return c.isArray(a)?(b=d.deferred(),e(c.clone(a),function(){b.resolve()}),b.promise()):(a.__manager__.isManaged=!0,a.render())});d.when(f).then(function(){g.resolveWith(b,[b.el])})}),g.then(function(){c.isFunction(a)&&a.call(b,b.el)}).promise()},remove:function(){return e(this),this._remove.apply(this,arguments)},_options:function(){return c.extend({},g.prototype.options,this.options)}},{_cache:{},_makeAsync:function(a,b){var c=a.deferred();return c.async=function(){return c._isAsync=!0,b},c},cache:function(a,b){if(a in this._cache)return this._cache[a];if(a!=null&&b!=null)return this._cache[a]=b},configure:function(a){c.extend(g.prototype.options,a)}});b.View.prototype.view=g.prototype.view,b.View.prototype.setViews=g.prototype.setViews,b.LayoutManager=g,b.LayoutManager.View=b.View,g.prototype.options={paths:{},deferred:function(){return d.Deferred()},fetch:function(a){return c.template(d(a).html())},partial:function(a,b,c,e){var f=b?d(a).find(b):d(a);this[e?"append":"html"](f,c)},html:function(a,b){d(a).html(b)},append:function(a,b){d(a).append(b)},detach:function(a){d(a).detach()},when:function(a){return d.when.apply(null,a)},render:function(a,b){return a(b)}}})(this)