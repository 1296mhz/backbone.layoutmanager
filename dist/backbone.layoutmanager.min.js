/*!
 * backbone.layoutmanager.js v0.7.0-wip
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(e){"use strict";var t,n=e.Backbone,r=e._,i=e.$,s=n.View.prototype._configure,o=n.View.prototype.render,u=n.View.extend({constructor:function(t){t=t||{},u.setupView(this,t),n.View.call(this,t)},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return r.each(e,function(t,n){e[n]=r.isArray(t)?t:[t]}),this.setViews(e)},getView:function(e){return this.getViews(e).first().value()},getViews:function(e){var t=r.chain(this.views).map(function(e){return r.isArray(e)?e:[e]},this).flatten().value();return r.chain(r.isFunction(e)?r.filter(t,e):t)},setView:function(e,t,n){var i,s,o,u,a=this;typeof e!="string"&&(n=t,t=e,e=""),this.views=this.views||{},i=t.__manager__,s=this.views[e];if(!i)throw new Error("Please set `manage` on the View with selector '"+e+"' to `true`.");return u=t._options(),i.parent=a,i.selector=e,n?(r.indexOf(s,t)<0&&(o=this.views[e]=[].concat(this.views[e]||[],t)),i.append=!0,t):(s&&r.each([].concat(s),function(e){e.remove()}),this.views[e]=t)},setViews:function(e){return r.each(e,function(e,t){if(r.isArray(e))return r.each(e,function(e){this.insertView(t,e)},this);this.setView(t,e)},this),this},render:function(){function i(e){t.parent&&!t.hasRendered&&n.partial(t.parent.el,t.selector,e.el,t.append),e._render(u._viewRender).done(function(){var t=e.getViews().map(function(e){return e.render()}).value();n.when(t).done(function(){r.resolveWith(e,[e.el])})})}var e=this,t=e.__manager__,n=e._options(),r=n.deferred();return r.done(function(){var n;t.queue&&((n=t.queue.shift())?r.done(function(){n(e)}):delete t.queue)}),t.queue?t.queue.push(function(){i(e)}):(t.queue=[],i(this)),r.view=e,r},remove:function(){return u._removeView(this,!0),this._remove.apply(this,arguments)},_options:function(){return r.extend({},this,u.prototype.options,this.options)}},{_cache:{},_makeAsync:function(e,t){var n=e.deferred();return n.async=function(){return n._isAsync=!0,t},n},_viewRender:function(e){function a(n,r){u.cache(t,r),r&&!o.hasRendered&&s.html(e.el,s.render(r,n)),i.resolveWith(e,[e.el])}var t,n,i,s=e._options(),o=e.__manager__;return{render:function(){var f,l=e.data||s.data||e.serialize||s.serialize,c=e.template||s.template;return r.isFunction(l)&&(l=l.call(e)),i=u._makeAsync(s,r.bind(a,e,l)),r.isString(c)&&(t=o.prefix+c),(n=u.cache(t))?(a(l,n,t),i):(r.isString(c)?n=s.fetch.call(i,o.prefix+c):c!=null&&(n=s.fetch.call(i,c)),i._isAsync||a(l,n),i)}}},_removeViews:function(e,t){r.isBoolean(e)&&(t=e,e=this),e=e||this,e.getViews().each(function(e){u._removeView(e,t)})},_removeView:function(e,t){var n=e.__manager__,i=r.isBoolean(e.keep)?e.keep:e.options.keep;t=n.parent?t:!1,u.cleanViews(e);if(!i&&(n.append===!0||t)){e.$el.remove();if(r.isArray(n.parent.views[n.selector]))return n.parent.getView(function(e,t){e.__manager__===n&&n.parent.views[n.selector].splice(t,1)});delete n.parent.views[n.selector]}},cleanViews:function(e){r.each([].concat(e),function(e){e.unbind(),e.views&&r.each(e.views,function(e){u.cleanViews(e)}),e.model instanceof n.Model&&e.model.off(null,null,e),e.collection instanceof n.Collection&&e.collection.off(null,null,e),r.isFunction(e.cleanup)&&e.cleanup.call(e)})},cache:function(e,t){if(e in this._cache)return this._cache[e];if(e!=null&&t!=null)return this._cache[e]=t},configure:function(e){r.extend(u.prototype.options,e),e.manage&&(n.View.prototype.manage=!0)},setupView:function(e,i){var s,o,a=n.LayoutManager.prototype,f=r.pick(e,t);if(e.__manager__)return;r.defaults(e,{views:{},__manager__:{},_removeViews:u._removeViews,_removeView:u._removeView},u.prototype),e instanceof n.Layout?e.__manager__.prefix=e._options().paths.layout||"":e.__manager__.prefix=e._options().paths.template||"",i=e.options=r.defaults(i||{},e.options,a.options),o=r.pick(i,["events"].concat(r.values(i.events))),r.extend(e,o),delete f.render,r.extend(i,f),e._remove=n.View.prototype.remove,e._render=function(e){var t,n=this,s=n.__manager__,o=this._options().beforeRender,u=this._options().afterRender;return s.hasRendered&&this._removeViews(),r.isFunction(o)&&o.call(this,this),this.trigger("beforeRender",this),t=e(this).render(),t.then(function(){var e=s.parent,t=function(){n.delegateEvents(),s.hasRendered=!0,r.isFunction(u)&&u.call(n,n),n.trigger("afterRender",n)};if(!e)return t.call(n);if(e.__manager__.hasRendered)return i.when([s.viewDeferred,e.__manager__.viewDeferred]).then(function(){t.call(n)});s.parent.on("afterRender",function(){s.parent.off(null,null,n),t.call(n)},n)}),t},e.render=u.prototype.render,e.remove!==a.remove&&(e._remove=e.remove,e.remove=a.remove),s=i.views||e.views,r.keys(s).length&&e.setViews(s),e.template&&(i.template=e.template,delete e.template)}});n.Layout=n.LayoutManager=u,n.LayoutView=n.View.extend({manage:!0}),u.VERSION="0.7.0",n.View.prototype._configure=function(){var e=s.apply(this,arguments);return this.manage&&u.setupView(this),e},u.prototype.options={paths:{},deferred:function(){return i.Deferred()},fetch:function(e){return r.template(i(e).html())},partial:function(e,t,n,r){var s=t?i(e).find(t):i(e);this[r?"append":"html"](s,n)},html:function(e,t){i(e).html(t)},append:function(e,t){i(e).append(t)},when:function(e){return i.when.apply(null,e)},render:function(e,t){return e(t)}},t=r.keys(u.prototype.options)})(this);